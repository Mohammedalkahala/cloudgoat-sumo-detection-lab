# 1) Critical Admin Policy Attachments (privilege escalation attempts)
# Counts AttachUserPolicy events from CloudTrail to detect when IAM policies are being attached.
_sourceCategory=aws/cloudtrail
| json "eventName"
| where eventName = "AttachUserPolicy"
| count

# 2) Attack Sources by IP Address (AssumeRole usage)
# Shows which IPs are using STS AssumeRole, grouped by event type.
_sourceCategory=aws/cloudtrail
| json "sourceIPAddress","eventName"
| where eventName in ("AttachUserPolicy","CreateFunction20150331","AssumeRole")
| count by sourceIPAddress, eventName

# 3) AWS Security Events Timeline (Activity over time)
# Visualizes AttachUserPolicy, CreateFunction20150331, and AssumeRole events over 5-minute slices.
_sourceCategory=aws/cloudtrail
| json "eventTime","eventName"
| where eventName in ("AttachUserPolicy","CreateFunction20150331","AssumeRole")
| timeslice 5m
| count by _timeslice, eventName
| transpose row _timeslice column eventName
